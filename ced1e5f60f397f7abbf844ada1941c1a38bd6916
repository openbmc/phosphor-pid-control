{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "2991e5b2_a5915168",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 23,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2025-10-27T20:27:46Z",
      "side": 1,
      "message": "From a control theory perspective, hysteresis isn\u0027t really a plant input, so it isn\u0027t clear why this would make a look more stable.  This WOULD make the loop more stable by reducing the integral coefficient when things are in the hysteresis band, but the hysteresis band is arbitrary?  Couldn\u0027t you get the same result by just decreasing the negative I coefficient by negHys and increase the positive I coefficient by posHys?\n\nIf we\u0027re going to add something non-standard, I\u0027m in support, but we really need to document why we\u0027re doing it if we\u0027re going outside what\u0027s generally documented in normal \"PID\" control theory textbooks.\n\nFWIW, we\u0027ve needed better docs on the control loop anyway, so probably best to do it now.",
      "revId": "ced1e5f60f397f7abbf844ada1941c1a38bd6916",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d89b5531_d33b0be1",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 23,
      "author": {
        "id": 1001843
      },
      "writtenOn": "2025-10-28T00:20:53Z",
      "side": 1,
      "message": "Thanks for the code review.\n\nI just double-checked pidcontroller.cpp, and I noticed that when the input goes below the negative hysteresis band, the community code initializes the PID by resetting both the integral accumulator and the output to zero.\n\nBefore we go further into the discussion of the dynamic setpoint logic, I think we should first revisit whether this “initialize PID” behavior (resetting integral and output) is really necessary — it might be too aggressive.\nIf the input happens to fluctuate around the lower hysteresis boundary, this reset can easily cause large oscillations.\n\nLet me give an example so it’s easier to visualize.\n(Assume: error \u003d setpoint - input)\n\nIf setpoint \u003d 83, Kp \u003d -5, Ki \u003d -2, Kd \u003d 0, and both positiveHysteresis and negativeHysteresis are 1:\n\nCase 1: With initialize PID (reset integral \u0026 output):\n\nT\u003d0, input\u003d85 → output \u003d -5(83-85) - 2*(83-85) \u003d 14\nT\u003d1, input\u003d85 → output \u003d -5(83-85) - 2*(83-85) - 2*(83-85) \u003d 18\nT\u003d2, input\u003d85 → output \u003d -5(83-85) - 2*(83-85) - 2*(83-85) - 2*(83-85) \u003d 22\nT\u003d3, input\u003d85 → output \u003d -5(83-85) - 2*(83-85) - 2*(83-85) - 2*(83-85) - 2*(83-85) \u003d 26\nT\u003d4, input\u003d85 → output \u003d -5(83-85) - 2*(83-85)*6 \u003d 30\nT\u003d5, input\u003d84 → output \u003d 30  (inside band → hold)\nT\u003d6, input\u003d83 → output \u003d 30  (inside band → hold)\nT\u003d7, input\u003d82 → output \u003d 30  (inside band → hold)\nT\u003d8, input\u003d81 → output \u003d 0   (below lower bound → PID reinitialized)\nT\u003d9, input\u003d82 → output \u003d 0   (inside band → hold)\n\n\nCase 2: Without reinitializing (keep integral accumulation):\n\nT\u003d0, input\u003d85 → output \u003d -5(83-85) - 2*(83-85) \u003d 14\nT\u003d1, input\u003d85 → output \u003d -5(83-85) - 2*(83-85) - 2*(83-85) \u003d 18\nT\u003d2, input\u003d85 → output \u003d -5(83-85) - 2*(83-85)*3 \u003d 22\nT\u003d3, input\u003d85 → output \u003d -5(83-85) - 2*(83-85)*4 \u003d 26\nT\u003d4, input\u003d85 → output \u003d -5(83-85) - 2*(83-85)*5 \u003d 30\nT\u003d5, input\u003d84 → output \u003d 30  (inside band → hold)\nT\u003d6, input\u003d83 → output \u003d 30  (inside band → hold)\nT\u003d7, input\u003d82 → output \u003d 30  (inside band → hold)\nT\u003d8, input\u003d81 → output \u003d -5(83-81) - accumulated integral \u003d 6 (below band, but continuous PID)\nT\u003d9, input\u003d82 → output \u003d 6   (inside band → hold)\n\n\nIf the input continues to stay below the setpoint, the output will naturally decay toward zero.\nAs long as ILimitMin and ILimitMax (e.g., 0–100) are properly configured — which are already part of the existing parameters — the integral wind-up problem is avoided.\n\nIn summary:\nForce-resetting the output and integral when the input leaves the lower hysteresis band seems unnecessarily harsh, especially after the integral has already accumulated for a while.\nIf the input oscillates around the hysteresis boundary, this behavior can lead to instability and make convergence difficult.\n\nWhile it’s true that proper PID tuning can mitigate some of these effects, I think algorithmic behavior and coefficient tuning can and should complement each other.\nA well-behaved control algorithm makes PID tuning much more effective and predictable.",
      "parentUuid": "2991e5b2_a5915168",
      "revId": "ced1e5f60f397f7abbf844ada1941c1a38bd6916",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3f182bd5_2d1bf884",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 23,
      "author": {
        "id": 1001843
      },
      "writtenOn": "2025-10-28T01:04:34Z",
      "side": 1,
      "message": "T\u003d8, input\u003d81 → output \u003d -5(83-81) - accumulated integral \u003d 6 (below band, but continuous PID)\n\nthe output is calculated as:\n\nT\u003d8, input \u003d 81, output \u003d -5(83-81)-2*(83-85)-2*(83-85)-2*(83-85)-2*(83-85)-2*(83-85)-2*(83-81) \u003d 6",
      "parentUuid": "d89b5531_d33b0be1",
      "revId": "ced1e5f60f397f7abbf844ada1941c1a38bd6916",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f172f9d0_e281dc6b",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 23,
      "author": {
        "id": 1001843
      },
      "writtenOn": "2025-10-28T01:28:01Z",
      "side": 1,
      "message": "I’m referring to the following section in pidcontroller.cpp:\n\n// Under the hysteresis bounds, initialize pid\nelse if (input \u003c (setpt - info-\u003enegativeHysteresis))\n{\n    lastInput \u003d setpt;\n    info-\u003eintegral \u003d 0;\n    output \u003d 0;\n}\n\n\nIn a traditional PID design, the controller normally continues integrating across the entire operating range — it doesn’t reinitialize or reset the integral term like this.\nThis behavior was probably introduced to prevent integral wind-up when the input stays far below the setpoint.\nHowever, since the current implementation already provides ILimitMin and ILimitMax parameters, proper configuration of these limits should be sufficient to prevent wind-up without needing to reset the PID state.",
      "parentUuid": "3f182bd5_2d1bf884",
      "revId": "ced1e5f60f397f7abbf844ada1941c1a38bd6916",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "657726ea_8fc97ace",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2025-10-27T20:27:46Z",
      "side": 1,
      "message": "I\u0027m very open to changes here, but lets make sure that:\n1. The benefits are documented well.\n2. If we\u0027re doing any control theory that\u0027s PPC specific, EXACTLY the expected behavior is documented and unit tested.  PID previously relied heavily on PID being a fairly routine algorithm, and our changes to it were rather routine/well documented.  I don\u0027t believe that\u0027s the case for this change, or if it is, please link the docs.",
      "revId": "ced1e5f60f397f7abbf844ada1941c1a38bd6916",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "dc7ce16d_4c61bae6",
        "filename": "pid/ec/pid.cpp",
        "patchSetId": 4
      },
      "lineNbr": 70,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2025-10-27T20:27:46Z",
      "side": 1,
      "message": "SHould we do this outside the actual \"pid\" call, because this isn\u0027t part of \"PID\".  This is arguably input filtering.",
      "revId": "ced1e5f60f397f7abbf844ada1941c1a38bd6916",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    }
  ]
}